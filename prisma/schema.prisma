// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL") // Lê a string de conexão do seu ficheiro .env
}

// Modelo de Usuários (Membros)
model User {
  id     String @id @default(uuid())
  name   String
  email  String @unique
  phone  String
  cpf    String @unique
  rg     String @unique
  password String
  role   UserRole @default(VOLUNTEER)
  status UserStatus @default(active)
  createdAt DateTime @default(now())

  address    Address?
  ministries MinistryMember[]
  schedulesCreated Schedule[] @relation("CreatedBy")
  schedules  ScheduleVolunteer[]
}

// Modelo de Endereços
model Address {
  id           String @id @default(uuid())
  userId       String @unique
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String
  state        String @db.VarChar(2)
  zipCode      String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Modelo de Ministérios
model Ministry {
  id          String   @id @default(uuid())
  name        String   @unique
  description String   @db.Text
  color       String   @db.VarChar(10)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  members   MinistryMember[]
  schedules Schedule[]
}

// Modelo de Ligação (Membros <-> Ministérios)
model MinistryMember {
  userId     String
  ministryId String

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ministry Ministry @relation(fields: [ministryId], references: [id], onDelete: Cascade)

  @@id([userId, ministryId])
}

// Modelo de Escalas (Eventos)
model Schedule {
  id          String   @id @default(uuid())
  type        String   // Ex: "Missa Dominical"
  date        DateTime @db.Date
  time        DateTime @db.Time
  notes       String?  @db.Text
  ministryId  String
  createdById String
  createdAt   DateTime @default(now())

  ministry      Ministry            @relation(fields: [ministryId], references: [id])
  createdBy     User                @relation("CreatedBy", fields: [createdById], references: [id])
  volunteers    ScheduleVolunteer[]
}

// Modelo de Participação (Voluntários nas Escalas)
model ScheduleVolunteer {
  id         String   @id @default(uuid())
  scheduleId String
  volunteerId String
  status     VolunteerStatus @default(PENDING)
  requestedChangeReason String?  @db.Text
  confirmedAt DateTime?

  schedule  Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  volunteer User     @relation(fields: [volunteerId], references: [id], onDelete: Cascade)

  @@unique([scheduleId, volunteerId], name: "schedule_volunteer_unique")
}


// --- Enums ---

enum UserRole {
  VOLUNTEER
  COORDINATOR
  DIRECTOR
}

enum UserStatus {
  active
  inactive
}

enum VolunteerStatus {
  PENDING
  CONFIRMED
  EXCHANGE_REQUESTED
}